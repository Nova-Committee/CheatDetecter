package top.infsky.cheatdetector.impl.checks.exploits;

import io.netty.channel.ChannelHandlerContext;
import net.minecraft.network.Connection;
import net.minecraft.network.protocol.Packet;
import net.minecraft.network.protocol.game.ClientGamePacketListener;
import net.minecraft.network.protocol.game.ClientboundMoveEntityPacket;
import org.jetbrains.annotations.NotNull;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfo;
import top.infsky.cheatdetector.config.AdvancedConfig;
import top.infsky.cheatdetector.impl.Check;
import top.infsky.cheatdetector.impl.utils.world.LevelUtils;
import top.infsky.cheatdetector.utils.TRPlayer;

import java.util.Objects;

public class TimerA extends Check {
    private long balance;
    public TimerA(@NotNull TRPlayer player) {
        super("*TimerA*", player);
        balance = AdvancedConfig.timerADefaultBalance;
    }

    @Override
    public void _onTick() {
        balance -= 50;
    }

    @Override
    public boolean _onPacketReceive(@NotNull Packet<ClientGamePacketListener> basePacket, Connection connection, ChannelHandlerContext channelHandlerContext, CallbackInfo ci) {
        if (basePacket instanceof ClientboundMoveEntityPacket packet) {
            try {
                if (!Objects.requireNonNull(packet.getEntity(LevelUtils.getClientLevel())).is(player.fabricPlayer)) return false;
            } catch (NullPointerException e) {
                return false;
            }

            balance += 50;

            if (balance >= AdvancedConfig.timerAFlagBalance) {
                flag();
                balance -= 50;  // 标记后应该忽略这个违规包
            }
        }
        return false;
    }

    @Override
    public int getAlertBuffer() {
        return AdvancedConfig.timerAAlertBuffer;
    }

    @Override
    public boolean isDisabled() {
        return !AdvancedConfig.timerACheck;
    }
}
